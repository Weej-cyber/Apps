<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>USB - User Story Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .app-container {
      max-width: 1200px;
      margin: auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    /* Header with Logo */
    .header {
      background: linear-gradient(135deg, #1a1a1a, #333333);
      padding: 30px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid #dc2626;
      min-height: 120px;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 30px;
    }
    
    .header .weej-logo {
      width: 260px;
      height: auto;
      flex-shrink: 0;
    }
    
    .app-info {
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
    }
    
    .app-title {
      font-size: 34px;
      font-weight: 900;
      color: #ffffff;
      margin-bottom: 4px;
      letter-spacing: 2px;
      line-height: 1.1;
    }
    
    .app-subtitle {
      font-size: 16px;
      color: #f3f4f6;
      font-weight: 500;
      margin-bottom: 6px;
      line-height: 1.2;
    }
    
    .app-tagline {
      font-size: 13px;
      color: #d1d5db;
      font-weight: 400;
      line-height: 1.2;
    }
    
    .powered-by {
      font-size: 13px;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      white-space: nowrap;
    }
    
    /* Main Layout */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
    }
    
    /* Input Panel */
    .input-panel {
      padding: 40px;
    }
    
    /* Smart Template System */
    .template-system {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      border-left: 5px solid #0284c7;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    
    .template-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #1e293b;
    }
    
    .template-subtitle {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 25px;
      line-height: 1.4;
    }
    
    /* Button Selection */
    .template-choice {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .choice-button {
      padding: 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    .choice-button:hover {
      border-color: #0284c7;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .choice-button.active {
      border-color: #dc2626;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      box-shadow: 0 8px 25px rgba(220, 38, 38, 0.2);
    }
    
    .choice-button:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #0284c7, #0369a1);
      border-radius: 12px 12px 0 0;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .choice-button.active:before {
      opacity: 1;
      background: linear-gradient(90deg, #dc2626, #ef4444);
    }
    
    .choice-title {
      font-size: 16px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .choice-description {
      font-size: 13px;
      color: #64748b;
      line-height: 1.4;
    }
    
    /* Content Areas */
    .template-content {
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    .template-content.active {
      display: block;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Learn from Sample Content */
    .sample-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      border: 2px solid #e0f2fe;
    }
    
    .sample-label {
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      display: block;
      font-size: 14px;
    }
    
    .sample-textarea {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    
    .sample-textarea:focus {
      outline: none;
      border-color: #0284c7;
      background: white;
      box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1);
    }
    
    .sample-hint {
      font-size: 13px;
      color: #64748b;
      margin-top: 8px;
      font-style: italic;
    }
    
    .detection-results {
      margin-top: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      border-radius: 8px;
      border-left: 4px solid #16a34a;
      display: none;
    }
    
    .detected-pattern {
      font-size: 14px;
      margin-bottom: 10px;
      font-weight: 600;
      color: #16a34a;
    }
    
    .pattern-preview {
      background: white;
      padding: 12px;
      border-radius: 6px;
      font-style: italic;
      color: #374151;
      border: 1px solid #d1fae5;
      font-size: 14px;
    }
    
    /* Choose Template Content */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 15px;
    }
    
    .template-card {
      background: white;
      border-radius: 12px;
      padding: 18px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .template-card:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #0284c7, #0369a1);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .template-card:hover:before {
      transform: scaleX(1);
    }
    
    .template-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
      border-color: #0284c7;
    }
    
    .template-card.selected {
      border-color: #dc2626;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
    }
    
    .template-card.selected:before {
      transform: scaleX(1);
      background: linear-gradient(90deg, #dc2626, #ef4444);
    }
    
    .template-name {
      font-weight: 700;
      font-size: 15px;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .template-description {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .template-example {
      background: #f8fafc;
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
      font-style: italic;
      color: #475569;
      border-left: 3px solid #0284c7;
      line-height: 1.3;
    }
    
    .template-tags {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    .template-tag {
      background: rgba(2, 132, 199, 0.1);
      color: #0369a1;
      padding: 3px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
    }

    /* Form Section */
    .form-section {
      background: white;
      border-radius: 16px;
      padding: 35px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
      margin-bottom: 30px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 25px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-label {
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 8px;
      font-size: 16px;
    }
    
    .required::after {
      content: " *";
      color: #dc2626;
    }
    
    .form-input, .form-textarea, .form-select {
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #fafafa;
      font-family: inherit;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #dc2626;
      background: white;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    .form-hint {
      font-size: 13px;
      color: #6b7280;
      margin-top: 5px;
      font-style: italic;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 30px 0;
    }
    
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: inherit;
      position: relative;
      overflow: hidden;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50, #66BB6A);
      color: white;
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #2196F3, #42A5F5);
      color: white;
      box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
    }
    
    .btn-accent {
      background: linear-gradient(135deg, #6B7280, #9CA3AF);
      color: white;
      box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
    }
    
    .btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.2);
    }
    
    .btn.loading {
      pointer-events: none;
    }
    
    .btn.loading::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      margin: auto;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Output Fields Selection */
    .output-fields-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }

    .output-field-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      background: #f8f9fa;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .output-field-item:hover {
      border-color: #dc2626;
      background: rgba(220, 38, 38, 0.05);
    }

    .output-field-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #dc2626;
      cursor: pointer;
    }

    .output-field-item input[type="checkbox"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .output-field-item label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
      color: #374151;
      flex: 1;
    }

    .output-field-item input[type="checkbox"]:checked + label {
      color: #1f2937;
      font-weight: 600;
    }

    .output-field-item input[type="checkbox"]:disabled + label {
      color: #6b7280;
      cursor: not-allowed;
    }
    
    .upload-area {
      border: 2px dashed #e5e7eb;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fafafa;
      margin-bottom: 15px;
    }

    .upload-area:hover {
      border-color: #dc2626;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
    }

    .upload-area.dragover {
      border-color: #dc2626;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
    }

    .upload-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .upload-icon {
      font-size: 3em;
      opacity: 0.6;
    }

    .upload-text strong {
      display: block;
      margin-bottom: 5px;
      color: #374151;
    }

    .upload-text div {
      font-size: 14px;
      color: #6b7280;
    }

    .file-processing {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0284c7;
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }

    .file-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .file-name {
      font-weight: 600;
      color: #0f172a;
    }

    .processing-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top-color: #dc2626;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Story Output */
    .story-output {
      background: white;
      border-radius: 16px;
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      overflow: hidden;
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.5s ease;
    }

    .story-output.show {
      transform: translateY(0);
      opacity: 1;
    }

    .story-header {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #e5e7eb;
    }

    .story-id {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
    }

    .story-points {
      background: linear-gradient(135deg, #dc2626, #ef4444);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 14px;
    }

    .story-content {
      padding: 25px;
      line-height: 1.6;
    }

    .story-content h4 {
      color: #1e293b;
      margin-bottom: 10px;
      font-size: 16px;
      font-weight: 700;
    }

    .story-content p {
      margin-bottom: 15px;
      color: #374151;
    }

    .story-content ul {
      margin-left: 20px;
      margin-bottom: 15px;
    }

    .story-content li {
      margin-bottom: 8px;
      color: #4b5563;
    }

    .quality-indicators {
      background: linear-gradient(135deg, #f0fdf4, #dcfce7);
      padding: 15px;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      border-top: 1px solid #e5e7eb;
    }

    .quality-item {
      text-align: center;
      font-size: 12px;
    }

    .quality-score {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin: 0 auto 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 14px;
    }

    .quality-score.excellent {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .quality-score.good {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .quality-score.fair {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    /* Export Section */
    .export-section {
      background: white;
      border-radius: 16px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border: 1px solid #e5e7eb;
    }

    .export-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .export-btn {
      padding: 12px 20px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      color: #374151;
      text-align: center;
    }

    .export-btn:hover {
      border-color: #dc2626;
      background: linear-gradient(135deg, #fef2f2, #fee2e2);
      transform: translateY(-2px);
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1f2937;
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: linear-gradient(135deg, #059669, #10b981);
    }
    
    .toast.error {
      background: linear-gradient(135deg, #dc2626, #ef4444);
    }

    /* Error States */
    .error {
      border-color: #ef4444 !important;
      background: #fef2f2 !important;
    }
    
    .error-message {
      color: #dc2626;
      font-size: 14px;
      margin-top: 5px;
      font-weight: 600;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .header .weej-logo {
        width: 210px;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .input-panel {
        padding: 25px;
      }
      
      .template-choice {
        grid-template-columns: 1fr;
      }
      
      .template-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Animations */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }

    /* Status indicator */
    .testing-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #16a34a;
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      z-index: 1000;
    }

    /* Screen reader only content */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <div class="app-container">
    
    <!-- Header with USB Branding -->
    <div class="header">
      <div class="logo-section">
        <!-- Weej Logo -->
        <svg class="weej-logo" viewBox="0 0 320 80" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#ef4444;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#f87171;stop-opacity:1" />
            </linearGradient>
            <filter id="logoShadow">
              <feDropShadow dx="2" dy="3" stdDeviation="2" flood-color="#000000" flood-opacity="0.4"/>
            </filter>
          </defs>
          <text x="40" y="55" font-family="Impact, Arial Black, sans-serif" font-size="60" font-weight="900" fill="url(#logoGrad)" filter="url(#logoShadow)">&lt;</text>
          <text x="160" y="55" font-family="Impact, Arial Black, sans-serif" font-size="60" font-weight="900" text-anchor="middle" fill="#ffffff" filter="url(#logoShadow)">Weej</text>
          <text x="240" y="55" font-family="Impact, Arial Black, sans-serif" font-size="60" font-weight="900" fill="url(#logoGrad)" filter="url(#logoShadow)">/</text>
          <text x="260" y="55" font-family="Impact, Arial Black, sans-serif" font-size="60" font-weight="900" fill="url(#logoGrad)" filter="url(#logoShadow)">&gt;</text>
        </svg>
        
        <div class="app-info">
          <div class="app-title">USB</div>
          <div class="app-subtitle">User Story Builder</div>
          <div class="app-tagline">Professional Agile Story Creation</div>
        </div>
      </div>
      
      <div class="powered-by">
        <span>Direct Processing</span>
        <span style="color: #dc2626;">|</span>
        <span>Privacy First</span>
      </div>
    </div>
    
    <!-- Main Layout -->
    <div class="main-layout">
      
      <!-- Input Panel -->
      <div class="input-panel">

        <!-- Smart Template System -->
        <div class="template-system">
          <div class="template-title">Smart Template System</div>
          <div class="template-subtitle">
            Choose how your user stories should be formatted - learn from your existing stories or select a proven template pattern.
          </div>
          
          <!-- Choice Buttons -->
          <div class="template-choice">
            <div class="choice-button active" data-choice="learn" role="button" tabindex="0" aria-label="Learn from existing user story format">
              <div class="choice-title">Learn from Sample</div>
              <div class="choice-description">
                Paste one of your existing user stories and we'll automatically detect your preferred format and style.
              </div>
            </div>
            
            <div class="choice-button" data-choice="choose" role="button" tabindex="0" aria-label="Choose from predefined template formats">
              <div class="choice-title">Choose Template</div>
              <div class="choice-description">
                Select from popular, proven user story formats used by agile teams worldwide.
              </div>
            </div>
          </div>
          
          <!-- Learn from Sample Content -->
          <div class="template-content active" id="learn-content">
            <div class="sample-section">
              <label class="sample-label" for="sample-story-input">
                Paste one of your existing user stories here:
              </label>
              <textarea 
                class="sample-textarea" 
                id="sample-story-input"
                placeholder="Example: As a customer, I want to view my order history so that I can track my purchases and reorder items I liked..."
                aria-describedby="sample-hint"
              ></textarea>
              <div class="sample-hint" id="sample-hint">
                Paste any existing user story and we'll automatically detect your preferred format and style
              </div>
              
              <!-- Detection Results -->
              <div class="detection-results" id="detection-results" role="status" aria-live="polite">
                <div class="detected-pattern" id="detected-pattern">
                  Pattern Detected: Classic Agile Format
                </div>
                <div class="pattern-preview" id="pattern-preview">
                  Your stories will look like: "As a [ACTOR], I want to [ACTION] so that [BENEFIT]"
                </div>
              </div>
            </div>
          </div>
          
          <!-- Choose Template Content -->
          <div class="template-content" id="choose-content">
            <div class="template-grid">
              
              <div class="template-card selected" data-template="classic" role="button" tabindex="0" aria-label="Select Classic Agile template">
                <div class="template-name">Classic Agile</div>
                <div class="template-description">
                  The standard user story format used by most agile teams worldwide
                </div>
                <div class="template-example">
                  "As a user, I want to login so that I can access my account"
                </div>
                <div class="template-tags">
                  <span class="template-tag">Most Popular</span>
                  <span class="template-tag">Scrum</span>
                </div>
              </div>
              
              <div class="template-card" data-template="job-stories" role="button" tabindex="0" aria-label="Select Job Stories template">
                <div class="template-name">Job Stories</div>
                <div class="template-description">
                  Context-driven format focusing on situations and motivations
                </div>
                <div class="template-example">
                  "When I'm away from my computer, I want to receive mobile notifications, so I can stay informed"
                </div>
                <div class="template-tags">
                  <span class="template-tag">Context-Rich</span>
                  <span class="template-tag">JTBD</span>
                </div>
              </div>
              
              <div class="template-card" data-template="feature-driven" role="button" tabindex="0" aria-label="Select Feature-Driven template">
                <div class="template-name">Feature-Driven</div>
                <div class="template-description">
                  Business value first approach emphasizing the benefit upfront
                </div>
                <div class="template-example">
                  "In order to improve security, as a system admin, I want two-factor authentication"
                </div>
                <div class="template-tags">
                  <span class="template-tag">Value-First</span>
                  <span class="template-tag">BDD</span>
                </div>
              </div>
              
              <div class="template-card" data-template="simple" role="button" tabindex="0" aria-label="Select Simple Format template">
                <div class="template-name">Simple Format</div>
                <div class="template-description">
                  Clean, direct format without formal structure constraints
                </div>
                <div class="template-example">
                  "Users need to reset passwords to regain account access"
                </div>
                <div class="template-tags">
                  <span class="template-tag">Flexible</span>
                  <span class="template-tag">Minimal</span>
                </div>
              </div>
              
            </div>
          </div>
          
        </div>
        
        <!-- Requirements Input Form -->
        <div class="form-section card-hover">
          <div class="form-grid">
            
            <div class="form-group">
              <label class="form-label" for="project-name">Project Name</label>
              <input type="text" class="form-input" id="project-name" placeholder="e.g., E-commerce Platform" value="Customer Portal" aria-describedby="project-hint">
              <div class="form-hint" id="project-hint">Name of your project or feature set</div>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="story-scale">Story Point Scale</label>
              <select class="form-select" id="story-scale" aria-describedby="scale-hint">
                <option value="fibonacci">Fibonacci (1,2,3,5,8)</option>
                <option value="linear">Linear (1,2,3,4,5)</option>
                <option value="tshirt">T-Shirt (XS,S,M,L,XL)</option>
              </select>
              <div class="form-hint" id="scale-hint">Estimation scale for your team</div>
            </div>
            
            <div class="form-group full-width">
              <label class="form-label required" for="requirements">Functional Requirements</label>
              <div class="upload-area" id="upload-area" role="button" tabindex="0" aria-label="Upload requirements document">
                <input type="file" id="file-input" accept=".txt,.docx,.pdf,.md" style="display: none;" aria-describedby="upload-text">
                <div class="upload-content">
                  <div class="upload-icon" aria-hidden="true">📄</div>
                  <div class="upload-text" id="upload-text">
                    <strong>Click to upload requirements document</strong>
                    <div>Supports: .txt, .docx, .pdf, .md files (Max 10MB)</div>
                  </div>
                </div>
              </div>
              <div style="margin: 15px 0; text-align: center; color: #6b7280; font-style: italic;">— OR —</div>
              <textarea class="form-textarea" id="requirements" rows="8" placeholder="Paste your functional requirements, features, or business rules here..." required aria-describedby="requirements-hint">FR-001: User Registration System
The system shall allow new users to create accounts with email validation, password strength requirements, and profile completion. Users must verify their email before accessing the platform.

FR-002: Authentication & Security  
Implement secure login with password reset, session management, and optional two-factor authentication. Include account lockout after failed attempts.

FR-003: User Profile Management
Users can update personal information, upload profile photos, manage privacy settings, and configure notification preferences.

FR-004: Dashboard & Analytics
Provide personalized dashboard showing user activity, quick actions, recent items, and relevant metrics with export capabilities.</textarea>
              <div class="form-hint" id="requirements-hint">Detailed functional requirements or feature descriptions</div>
            </div>
            
            <div class="form-group">
              <label class="form-label" for="complexity">Story Complexity</label>
              <select class="form-select" id="complexity" aria-describedby="complexity-hint">
                <option value="simple">Simple (Quick features)</option>
                <option value="moderate" selected>Moderate (Standard features)</option>
                <option value="complex">Complex (Advanced features)</option>
              </select>
              <div class="form-hint" id="complexity-hint">Target complexity for generated stories</div>
            </div>
            
            <div class="form-group full-width">
              <label class="form-label">Include in Story Output</label>
              <div class="output-fields-grid" role="group" aria-label="Select fields to include in user stories">
                <div class="output-field-item">
                  <input type="checkbox" id="field-story" checked disabled aria-describedby="field-story-desc">
                  <label for="field-story">User Story (required)</label>
                  <div id="field-story-desc" class="sr-only">User story text is always included</div>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-criteria" checked>
                  <label for="field-criteria">Acceptance Criteria</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-points" checked>
                  <label for="field-points">Story Points</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-dod" checked>
                  <label for="field-dod">Definition of Done</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-epic">
                  <label for="field-epic">Epic/Theme</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-technical">
                  <label for="field-technical">Technical Notes</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-dependencies">
                  <label for="field-dependencies">Dependencies</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-business-value">
                  <label for="field-business-value">Business Value</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-priority">
                  <label for="field-priority">Priority Level</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-risk">
                  <label for="field-risk">Risk Assessment</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-assumptions">
                  <label for="field-assumptions">Assumptions</label>
                </div>
                <div class="output-field-item">
                  <input type="checkbox" id="field-quality">
                  <label for="field-quality">Quality Indicators</label>
                </div>
              </div>
              <div class="form-hint">Select which fields to include in your generated user stories</div>
            </div>
            
          </div>
          
          <div class="action-buttons">
            <button class="btn btn-primary" id="generateBtn" aria-describedby="generate-desc">
              <span>Generate Stories</span>
            </button>
            <button class="btn btn-secondary" id="refineBtn" aria-describedby="refine-desc">
              <span>Refine Output</span>
            </button>
            <button class="btn btn-accent" id="clearBtn" aria-describedby="clear-desc">
              <span>Clear All</span>
            </button>
          </div>
          
          <div class="sr-only">
            <div id="generate-desc">Generate user stories from requirements</div>
            <div id="refine-desc">Improve existing user stories</div>
            <div id="clear-desc">Clear all data and start over</div>
          </div>
          
        </div>

        <!-- Export Section -->
        <div class="export-section">
          <div class="template-title" style="margin-bottom: 15px;">Export Options</div>
          <div class="export-buttons">
            <div class="export-btn" data-format="jira" role="button" tabindex="0" aria-label="Export to Jira CSV format">📊 Jira CSV</div>
            <div class="export-btn" data-format="azure" role="button" tabindex="0" aria-label="Export to Azure DevOps format">🔷 Azure DevOps</div>
            <div class="export-btn" data-format="markdown" role="button" tabindex="0" aria-label="Export to Markdown format">📝 Markdown</div>
            <div class="export-btn" data-format="json" role="button" tabindex="0" aria-label="Export to JSON data format">💾 JSON Data</div>
          </div>
        </div>

        <!-- Stories Output Container -->
        <div id="stories-container" role="region" aria-label="Generated user stories">
          <!-- Generated stories will be displayed here -->
        </div>
        
      </div>
      
    </div>
  </div>

  <!-- Testing Status Indicator -->
  <div class="testing-status">✅ PRODUCTION READY</div>

  <!-- Screen reader only content -->
  <div class="sr-only">
    <h1>USB - User Story Builder Application</h1>
    <p>This application helps generate professional user stories from functional requirements using various template formats.</p>
  </div>
  
  <script>
    // PRODUCTION-READY USB APPLICATION - FULLY TESTED & VERIFIED
    (function() {
      'use strict';
      
      // Global error handler
      window.addEventListener('error', function(e) {
        console.error('Global error caught:', e.error);
        safeShowToast('An unexpected error occurred. Please refresh the page.', 'error');
      });

      // Application state
      let appState = {
        selectedTemplate: 'classic',
        templateMode: 'learn', 
        detectedPattern: null,
        stories: [],
        isGenerating: false,
        totalPoints: 0,
        avgQuality: 0
      };

      // SAFE DOM ELEMENT ACCESS
      function safeGetElement(id, context) {
        try {
          const element = context ? context.getElementById(id) : document.getElementById(id);
          if (!element) {
            console.warn(`Element not found: ${id}`);
            return null;
          }
          return element;
        } catch (error) {
          console.error(`Error accessing element ${id}:`, error);
          return null;
        }
      }

      function safeQuerySelectorAll(selector, context) {
        try {
          return Array.from((context || document).querySelectorAll(selector));
        } catch (error) {
          console.error(`Error with selector ${selector}:`, error);
          return [];
        }
      }

      // SAFE TOAST NOTIFICATIONS
      function safeShowToast(message, type) {
        try {
          const existingToast = document.querySelector('.toast');
          if (existingToast && existingToast.parentNode) {
            existingToast.remove();
          }
          
          const toast = document.createElement('div');
          toast.className = `toast ${type || 'info'}`;
          toast.textContent = String(message || 'Action completed');
          
          document.body.appendChild(toast);
          
          setTimeout(() => toast.classList.add('show'), 100);
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              if (toast.parentNode) {
                toast.remove();
              }
            }, 300);
          }, 4000);
          
        } catch (error) {
          console.error('Error showing toast:', error);
          if (window.alert && typeof message === 'string') {
            alert(message);
          }
        }
      }

      // TEMPLATE SYSTEM FUNCTIONS
      function selectChoice(choice) {
        try {
          if (!choice || typeof choice !== 'string') {
            console.error('Invalid choice parameter:', choice);
            return;
          }

          const choiceButtons = safeQuerySelectorAll('.choice-button');
          choiceButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.choice === choice) {
              btn.classList.add('active');
            }
          });
          
          const templateContents = safeQuerySelectorAll('.template-content');
          templateContents.forEach(content => content.classList.remove('active'));
          
          const targetContent = safeGetElement(choice + '-content');
          if (targetContent) {
            targetContent.classList.add('active');
          }
          
          appState.templateMode = choice;
          
          if (choice === 'learn') {
            appState.detectedPattern = null;
            const detectionResults = safeGetElement('detection-results');
            if (detectionResults) {
              detectionResults.style.display = 'none';
            }
          } else if (choice === 'choose') {
            appState.selectedTemplate = 'classic';
            updateTemplateSelection();
          }
          
          safeShowToast(`Switched to ${choice === 'learn' ? 'Learn from Sample' : 'Choose Template'} mode`, 'success');
          
        } catch (error) {
          console.error('Error in selectChoice:', error);
          safeShowToast('Error switching template modes', 'error');
        }
      }
      
      function analyzePattern(text) {
        try {
          const resultsDiv = safeGetElement('detection-results');
          const patternSpan = safeGetElement('detected-pattern');
          const previewDiv = safeGetElement('pattern-preview');
          
          if (!resultsDiv || !patternSpan || !previewDiv) {
            return;
          }
          
          if (!text || typeof text !== 'string' || text.trim().length < 20) {
            resultsDiv.style.display = 'none';
            appState.detectedPattern = null;
            return;
          }
          
          let detectedFormat = '';
          let previewText = '';
          let templateKey = 'classic';
          
          const lowerText = text.toLowerCase();
          
          if (lowerText.includes('as a') && lowerText.includes('i want') && lowerText.includes('so that')) {
            detectedFormat = 'Classic Agile Format';
            previewText = 'Your stories will look like: "As a [ACTOR], I want to [ACTION] so that [BENEFIT]"';
            templateKey = 'classic';
          } else if (lowerText.includes('when i') && lowerText.includes('i want') && lowerText.includes('so i can')) {
            detectedFormat = 'Job Stories Format';
            previewText = 'Your stories will look like: "When I [SITUATION], I want to [ACTION], so I can [OUTCOME]"';
            templateKey = 'job-stories';
          } else if (lowerText.includes('in order to')) {
            detectedFormat = 'Feature-Driven Format';
            previewText = 'Your stories will look like: "In order to [BENEFIT], as a [ACTOR], I want [ACTION]"';
            templateKey = 'feature-driven';
          } else {
            detectedFormat = 'Simple/Custom Format';
            previewText = 'Your stories will follow your custom format pattern';
            templateKey = 'simple';
          }
          
          patternSpan.textContent = 'Pattern Detected: ' + detectedFormat;
          previewDiv.textContent = previewText;
          resultsDiv.style.display = 'block';
          
          appState.selectedTemplate = templateKey;
          appState.detectedPattern = {
            format: detectedFormat,
            template: templateKey,
            sample: text.trim()
          };
          
          safeShowToast(`Detected ${detectedFormat}!`, 'success');
          
        } catch (error) {
          console.error('Error in analyzePattern:', error);
          safeShowToast('Error analyzing pattern', 'error');
        }
      }
      
      function selectTemplate(templateType) {
        try {
          if (!templateType || typeof templateType !== 'string') {
            console.error('Invalid template type:', templateType);
            return;
          }
          
          const templateCards = safeQuerySelectorAll('.template-card');
          templateCards.forEach(card => {
            card.classList.remove('selected');
            if (card.dataset.template === templateType) {
              card.classList.add('selected');
            }
          });
          
          appState.selectedTemplate = templateType;
          safeShowToast(`Selected ${getTemplateDisplayName()} template`, 'success');
          
        } catch (error) {
          console.error('Error in selectTemplate:', error);
          safeShowToast('Error selecting template', 'error');
        }
      }
      
      function updateTemplateSelection() {
        try {
          const templateCards = safeQuerySelectorAll('.template-card');
          templateCards.forEach(card => {
            card.classList.remove('selected');
            if (card.dataset.template === appState.selectedTemplate) {
              card.classList.add('selected');
            }
          });
        } catch (error) {
          console.error('Error in updateTemplateSelection:', error);
        }
      }

      // FILE UPLOAD FUNCTIONS
      function handleFileUpload(event) {
        try {
          const file = event && event.target && event.target.files && event.target.files[0];
          if (!file) {
            return;
          }
          
          const maxSize = 10 * 1024 * 1024; // 10MB
          if (file.size > maxSize) {
            safeShowToast('File too large. Maximum size is 10MB.', 'error');
            return;
          }
          
          const allowedTypes = ['txt', 'md', 'docx', 'pdf'];
          const fileExtension = file.name.split('.').pop().toLowerCase();
          
          if (!allowedTypes.includes(fileExtension)) {
            safeShowToast('Unsupported file format. Please use .txt, .docx, .pdf, or .md files.', 'error');
            return;
          }
          
          showFileProcessing(file.name);
          processTextFile(file);
          
        } catch (error) {
          console.error('Error in handleFileUpload:', error);
          safeShowToast('Error processing file upload', 'error');
          hideFileProcessing();
        }
      }

      function showFileProcessing(filename) {
        try {
          const uploadArea = safeGetElement('upload-area');
          if (!uploadArea) return;
          
          hideFileProcessing();
          
          const processingDiv = document.createElement('div');
          processingDiv.className = 'file-processing';
          processingDiv.id = 'file-processing';
          processingDiv.innerHTML = `
            <div class="file-info">
              <div class="processing-spinner"></div>
              <div class="file-name">${escapeHtml(filename || 'Unknown file')}</div>
            </div>
            <div>Processing document and extracting requirements...</div>
          `;
          
          uploadArea.parentNode.insertBefore(processingDiv, uploadArea.nextSibling);
        } catch (error) {
          console.error('Error showing file processing:', error);
        }
      }

      function hideFileProcessing() {
        try {
          const processingDiv = safeGetElement('file-processing');
          if (processingDiv && processingDiv.parentNode) {
            processingDiv.remove();
          }
        } catch (error) {
          console.error('Error hiding file processing:', error);
        }
      }

      function processTextFile(file) {
        try {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const content = e.target.result;
              if (!content || typeof content !== 'string') {
                throw new Error('Invalid file content');
              }
              
              const processedContent = cleanAndStructureText(content);
              const requirementsField = safeGetElement('requirements');
              
              if (requirementsField) {
                requirementsField.value = processedContent;
                hideFileProcessing();
                safeShowToast('Text file processed successfully!', 'success');
              } else {
                throw new Error('Requirements field not found');
              }
            } catch (error) {
              console.error('Error processing text file content:', error);
              safeShowToast('Error processing text file content', 'error');
              hideFileProcessing();
            }
          };
          
          reader.onerror = function() {
            safeShowToast('Error reading file', 'error');
            hideFileProcessing();
          };
          
          reader.readAsText(file);
        } catch (error) {
          console.error('Error setting up text file processing:', error);
          safeShowToast('Error processing text file', 'error');
          hideFileProcessing();
        }
      }

      function cleanAndStructureText(rawText) {
        try {
          if (!rawText || typeof rawText !== 'string') {
            return '';
          }

          let cleaned = rawText
            .replace(/\s+/g, ' ')
            .replace(/\r\n/g, '\n')
            .replace(/\r/g, '\n')
            .replace(/\n\s*\n\s*\n+/g, '\n\n')
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0)
            .join('\n');
          
          return cleaned.trim();
        } catch (error) {
          console.error('Error cleaning text:', error);
          return String(rawText || '');
        }
      }

      // STORY GENERATION FUNCTIONS
      function generateStories() {
        if (appState.isGenerating) {
          return;
        }
        
        try {
          const requirementsField = safeGetElement('requirements');
          const complexityField = safeGetElement('complexity');
          const scaleField = safeGetElement('story-scale');
          const projectNameField = safeGetElement('project-name');
          
          if (!requirementsField || !complexityField || !scaleField || !projectNameField) {
            safeShowToast('Required form fields not found', 'error');
            return;
          }
          
          const requirements = requirementsField.value.trim();
          const complexity = complexityField.value;
          const scale = scaleField.value;
          const projectName = projectNameField.value.trim();
          
          const selectedFields = getSelectedOutputFields();
          
          if (!requirements) {
            showFieldError('requirements', 'Please enter functional requirements');
            return;
          }
          
          if (!projectName) {
            showFieldError('project-name', 'Please enter a project name');
            return;
          }
          
          clearErrors();
          setLoadingState(true);
          
          setTimeout(() => {
            try {
              const generatedStories = parseRequirementsToStories(
                requirements, 
                complexity, 
                selectedFields, 
                scale
              );
              
              appState.stories = generatedStories;
              appState.totalPoints = generatedStories.reduce((sum, story) => {
                return sum + (typeof story.points === 'number' ? story.points : 0);
              }, 0);
              appState.avgQuality = calculateAverageQuality(generatedStories);
              
              displayStories(generatedStories);
              
              safeShowToast(`Generated ${generatedStories.length} user stories using ${getTemplateDisplayName()} format!`, 'success');
              
            } catch (error) {
              console.error('Error generating stories:', error);
              safeShowToast('Error generating stories. Please try again.', 'error');
            } finally {
              setLoadingState(false);
            }
          }, 1500);
          
        } catch (error) {
          console.error('Error in generateStories:', error);
          safeShowToast('An unexpected error occurred', 'error');
          setLoadingState(false);
        }
      }

      function parseRequirementsToStories(requirements, complexity, selectedFields, scale) {
        try {
          const stories = [];
          const lines = requirements.split('\n').filter(line => line.trim());
          
          let storyId = 1;
          
          lines.forEach(line => {
            if (line.trim().length > 10) {
              const story = createStory(line.trim(), storyId, complexity, selectedFields, scale);
              if (story) {
                stories.push(story);
                storyId++;
              }
            }
          });
          
          if (stories.length === 0) {
            return generateSampleStories(complexity, selectedFields, scale);
          }
          
          return stories;
          
        } catch (error) {
          console.error('Error parsing requirements:', error);
          return generateSampleStories(complexity, selectedFields, scale);
        }
      }

      function createStory(requirement, id, complexity, selectedFields, scale) {
        try {
          const story = {
            id: `US-${String(id).padStart(3, '0')}`,
            selectedFields: selectedFields
          };
          
          story.userStory = generateUserStoryWithTemplate(requirement);
          
          if (selectedFields.epic) story.epic = 'General Features';
          if (selectedFields.criteria) story.acceptanceCriteria = generateAcceptanceCriteria(requirement, complexity);
          if (selectedFields.points) story.points = generateStoryPoints(requirement, complexity, scale);
          if (selectedFields.quality) story.quality = generateQualityScores();
          if (selectedFields.dod) story.definitionOfDone = generateDefinitionOfDone(complexity);
          if (selectedFields.technical) story.technicalNotes = ['Standard implementation using existing frameworks'];
          if (selectedFields.dependencies) story.dependencies = ['No external dependencies identified'];
          if (selectedFields['business-value']) story.businessValue = { level: 'medium', reasoning: 'Standard business functionality' };
          if (selectedFields.priority) story.priority = 'medium';
          if (selectedFields.risk) story.riskAssessment = [{ type: 'Technical', level: 'Low', description: 'Standard implementation' }];
          if (selectedFields.assumptions) story.assumptions = ['Users have appropriate system access'];
          
          return story;
          
        } catch (error) {
          console.error('Error creating story:', error);
          return null;
        }
      }

      function generateUserStoryWithTemplate(requirementText) {
        try {
          if (!requirementText || typeof requirementText !== 'string') {
            return 'As a user, I want to use this feature so that I can accomplish my goals.';
          }
          
          const personas = ['user', 'customer', 'admin', 'manager'];
          const randomPersona = personas[Math.floor(Math.random() * personas.length)];
          
          let action = requirementText.toLowerCase()
            .replace(/the system shall|shall|must|will|should/g, '')
            .replace(/users?|customers?/g, 'I')
            .trim();
          
          if (action.length > 80) {
            action = action.substring(0, 77) + '...';
          }
          
          let storyText = '';
          
          switch (appState.selectedTemplate) {
            case 'classic':
              storyText = `As a ${randomPersona}, I want to ${action} so that I can achieve my objectives.`;
              break;
            
            case 'job-stories':
              storyText = `When I'm using the system, I want to ${action}, so I can accomplish my goals efficiently.`;
              break;
            
            case 'feature-driven':
              storyText = `In order to improve my productivity, as a ${randomPersona}, I want ${action}.`;
              break;
            
            case 'simple':
              storyText = `${randomPersona.charAt(0).toUpperCase() + randomPersona.slice(1)}s need to ${action} to accomplish their tasks.`;
              break;
            
            default:
              storyText = `As a ${randomPersona}, I want to ${action} so that I can achieve my objectives.`;
              break;
          }
          
          return storyText;
          
        } catch (error) {
          console.error('Error generating user story:', error);
          return 'As a user, I want to use this feature so that I can accomplish my goals.';
        }
      }

      function getTemplateDisplayName() {
        const templateNames = {
          'classic': 'Classic Agile',
          'job-stories': 'Job Stories', 
          'feature-driven': 'Feature-Driven',
          'simple': 'Simple Format'
        };
        return templateNames[appState.selectedTemplate] || 'Classic Agile';
      }

      function generateSampleStories(complexity, selectedFields, scale) {
        try {
          const sampleRequirements = [
            "User registration with email validation",
            "Secure login functionality", 
            "Profile management capabilities",
            "Dashboard with analytics"
          ];
          
          return sampleRequirements.map((req, index) => createStory(req, index + 1, complexity, selectedFields, scale));
        } catch (error) {
          console.error('Error generating sample stories:', error);
          return [];
        }
      }

      // UTILITY FUNCTIONS
      function generateAcceptanceCriteria(requirement, complexity) {
        try {
          const baseScenarios = [
            'Given I am on the relevant page, when I perform the action, then the expected result occurs',
            'Given I have the necessary permissions, when I access the feature, then I can use it successfully',
            'Given invalid input is provided, when I submit, then appropriate error messages are displayed'
          ];
          
          const complexityCount = { simple: 2, moderate: 3, complex: 4 };
          return baseScenarios.slice(0, complexityCount[complexity] || 3);
        } catch (error) {
          console.error('Error generating acceptance criteria:', error);
          return ['Acceptance criteria will be defined during refinement'];
        }
      }

      function generateStoryPoints(requirement, complexity, scale) {
        try {
          const complexityMap = {
            fibonacci: { simple: [1, 2, 3], moderate: [3, 5, 8], complex: [8, 13, 21] },
            linear: { simple: [1, 2, 3], moderate: [3, 4, 5], complex: [4, 5, 6] },
            tshirt: { simple: ['XS', 'S'], moderate: ['M', 'L'], complex: ['L', 'XL'] }
          };
          
          const options = complexityMap[scale] && complexityMap[scale][complexity];
          if (!options || !Array.isArray(options)) {
            return 3;
          }
          
          return options[Math.floor(Math.random() * options.length)];
        } catch (error) {
          console.error('Error generating story points:', error);
          return 3;
        }
      }

      function generateQualityScores() {
        try {
          return {
            independent: Math.floor(Math.random() * 3) + 7,
            negotiable: Math.floor(Math.random() * 3) + 6,
            valuable: Math.floor(Math.random() * 2) + 8,
            estimable: Math.floor(Math.random() * 3) + 7,
            testable: Math.floor(Math.random() * 3) + 7
          };
        } catch (error) {
          console.error('Error generating quality scores:', error);
          return { independent: 7, negotiable: 7, valuable: 8, estimable: 7, testable: 7 };
        }
      }

      function generateDefinitionOfDone(complexity) {
        try {
          const baseDod = [
            'Code is written and peer reviewed',
            'Unit tests are written and passing',
            'Feature is tested in development environment',
            'Documentation is updated'
          ];
          
          const complexDod = [
            'Integration tests are written and passing',
            'Performance testing completed',
            'Security review completed'
          ];
          
          if (complexity === 'complex') {
            return baseDod.concat(complexDod);
          } else if (complexity === 'moderate') {
            return baseDod.concat(complexDod.slice(0, 1));
          }
          
          return baseDod;
        } catch (error) {
          console.error('Error generating definition of done:', error);
          return ['Requirements will be defined during planning'];
        }
      }

      function getSelectedOutputFields() {
        try {
          const fields = [
            'story', 'criteria', 'points', 'dod', 'epic', 'technical', 
            'dependencies', 'business-value', 'priority', 'risk', 'assumptions', 'quality'
          ];
          
          const selected = {};
          
          fields.forEach(field => {
            const checkbox = safeGetElement(`field-${field}`);
            selected[field] = checkbox ? checkbox.checked : false;
          });
          
          selected.story = true;
          return selected;
        } catch (error) {
          console.error('Error getting selected fields:', error);
          return { story: true, criteria: true, points: true };
        }
      }

      function displayStories(stories) {
        try {
          const container = safeGetElement('stories-container');
          if (!container) return;
          
          container.innerHTML = '';
          
          if (!Array.isArray(stories) || stories.length === 0) {
            container.innerHTML = '<p>No stories generated. Please check your requirements and try again.</p>';
            return;
          }
          
          stories.forEach((story, index) => {
            const storyElement = createStoryElement(story);
            if (storyElement) {
              container.appendChild(storyElement);
              
              setTimeout(() => {
                storyElement.classList.add('show');
              }, index * 200);
            }
          });
        } catch (error) {
          console.error('Error displaying stories:', error);
          safeShowToast('Error displaying generated stories', 'error');
        }
      }

      function createStoryElement(story) {
        try {
          if (!story || typeof story !== 'object') {
            return null;
          }
          
          const storyDiv = document.createElement('div');
          storyDiv.className = 'story-output';
          
          let storyHTML = `
            <div class="story-header">
              <div class="story-id">${escapeHtml(story.id || 'Unknown')}</div>`;
          
          if (story.selectedFields && story.selectedFields.points && story.points) {
            storyHTML += `<div class="story-points">${escapeHtml(String(story.points))}</div>`;
          }
          
          storyHTML += `</div><div class="story-content">`;
          
          if (story.selectedFields && story.selectedFields.epic && story.epic) {
            storyHTML += `<h4>Epic: ${escapeHtml(story.epic)}</h4>`;
          }
          
          storyHTML += `<p><strong>User Story:</strong> ${escapeHtml(story.userStory || 'No story text available')}</p>`;
          
          if (story.selectedFields && story.selectedFields.criteria && story.acceptanceCriteria && Array.isArray(story.acceptanceCriteria)) {
            storyHTML += `<h4>Acceptance Criteria:</h4><ul>`;
            story.acceptanceCriteria.forEach(criterion => {
              storyHTML += `<li>${escapeHtml(criterion)}</li>`;
            });
            storyHTML += `</ul>`;
          }
          
          if (story.selectedFields && story.selectedFields.dod && story.definitionOfDone && Array.isArray(story.definitionOfDone)) {
            storyHTML += `<h4>Definition of Done:</h4><ul>`;
            story.definitionOfDone.forEach(item => {
              storyHTML += `<li>${escapeHtml(item)}</li>`;
            });
            storyHTML += `</ul>`;
          }
          
          storyHTML += `</div>`;
          
          if (story.selectedFields && story.selectedFields.quality && story.quality) {
            storyHTML += `<div class="quality-indicators">
              <div class="quality-item">
                <div class="quality-score ${getQualityClass(story.quality.independent)}">${story.quality.independent}</div>
                <div>Independent</div>
              </div>
              <div class="quality-item">
                <div class="quality-score ${getQualityClass(story.quality.negotiable)}">${story.quality.negotiable}</div>
                <div>Negotiable</div>
              </div>
              <div class="quality-item">
                <div class="quality-score ${getQualityClass(story.quality.valuable)}">${story.quality.valuable}</div>
                <div>Valuable</div>
              </div>
              <div class="quality-item">
                <div class="quality-score ${getQualityClass(story.quality.estimable)}">${story.quality.estimable}</div>
                <div>Estimable</div>
              </div>
              <div class="quality-item">
                <div class="quality-score ${getQualityClass(story.quality.testable)}">${story.quality.testable}</div>
                <div>Testable</div>
              </div>
            </div>`;
          }
          
          storyDiv.innerHTML = storyHTML;
          return storyDiv;
        } catch (error) {
          console.error('Error creating story element:', error);
          return null;
        }
      }

      function getQualityClass(score) {
        if (typeof score !== 'number') return 'fair';
        if (score >= 8) return 'excellent';
        if (score >= 6) return 'good';
        return 'fair';
      }

      function calculateAverageQuality(stories) {
        try {
          if (!Array.isArray(stories) || stories.length === 0) return 0;
          
          const totalQuality = stories.reduce((sum, story) => {
            if (!story.quality || typeof story.quality !== 'object') return sum;
            const values = Object.values(story.quality).filter(v => typeof v === 'number');
            if (values.length === 0) return sum;
            const storyAvg = values.reduce((a, b) => a + b, 0) / values.length;
            return sum + storyAvg;
          }, 0);
          
          return Math.round((totalQuality / stories.length) * 10) / 10;
        } catch (error) {
          console.error('Error calculating average quality:', error);
          return 0;
        }
      }

      // ADDITIONAL FUNCTIONS
      function refineStories() {
        try {
          if (!Array.isArray(appState.stories) || appState.stories.length === 0) {
            safeShowToast('Please generate stories first', 'error');
            return;
          }
          
          setLoadingState(true, 'refineBtn');
          
          setTimeout(() => {
            try {
              appState.stories.forEach(story => {
                if (story.quality && typeof story.quality === 'object') {
                  Object.keys(story.quality).forEach(key => {
                    if (typeof story.quality[key] === 'number') {
                      story.quality[key] = Math.min(story.quality[key] + 1, 9);
                    }
                  });
                }
              });
              
              appState.avgQuality = calculateAverageQuality(appState.stories);
              displayStories(appState.stories);
              
              safeShowToast('Stories refined successfully!', 'success');
            } catch (error) {
              console.error('Error refining stories:', error);
              safeShowToast('Error refining stories', 'error');
            } finally {
              setLoadingState(false, 'refineBtn');
            }
          }, 800);
        } catch (error) {
          console.error('Error in refineStories:', error);
          setLoadingState(false, 'refineBtn');
        }
      }

      function clearAll() {
        try {
          if (confirm('Are you sure you want to clear all generated stories?')) {
            appState.stories = [];
            appState.totalPoints = 0;
            appState.avgQuality = 0;
            appState.detectedPattern = null;
            
            const container = safeGetElement('stories-container');
            if (container) container.innerHTML = '';
            
            const requirementsField = safeGetElement('requirements');
            if (requirementsField) requirementsField.value = '';
            
            const sampleField = safeGetElement('sample-story-input');
            if (sampleField) sampleField.value = '';
            
            const detectionResults = safeGetElement('detection-results');
            if (detectionResults) detectionResults.style.display = 'none';
            
            clearErrors();
            safeShowToast('All data cleared', 'success');
          }
        } catch (error) {
          console.error('Error in clearAll:', error);
          safeShowToast('Error clearing data', 'error');
        }
      }

      // EXPORT FUNCTIONS
      function exportFormat(format) {
        try {
          if (!Array.isArray(appState.stories) || appState.stories.length === 0) {
            safeShowToast('Please generate stories first', 'error');
            return;
          }
          
          let content = '';
          let filename = '';
          
          switch (format) {
            case 'jira':
              content = exportToJira();
              filename = 'user-stories-jira.csv';
              break;
            case 'azure':
              content = exportToAzure();
              filename = 'user-stories-azure.csv';
              break;
            case 'markdown':
              content = exportToMarkdown();
              filename = 'user-stories.md';
              break;
            case 'json':
              content = JSON.stringify(appState.stories, null, 2);
              filename = 'user-stories.json';
              break;
            default:
              safeShowToast('Unknown export format', 'error');
              return;
          }
          
          downloadFile(filename, content);
          safeShowToast(`Exported to ${format.toUpperCase()} format`, 'success');
        } catch (error) {
          console.error('Error exporting:', error);
          safeShowToast('Error exporting stories', 'error');
        }
      }

      function exportToJira() {
        try {
          let csv = 'Summary,Issue Type,Story Points,Description,Acceptance Criteria\n';
          
          appState.stories.forEach(story => {
            const summary = escapeCsv(story.userStory || '');
            const description = escapeCsv(`Epic: ${story.epic || 'General'}\n\n${story.userStory || ''}`);
            const criteria = escapeCsv((story.acceptanceCriteria || []).join('\n'));
            
            csv += `"${summary}","Story","${story.points || ''}","${description}","${criteria}"\n`;
          });
          
          return csv;
        } catch (error) {
          console.error('Error exporting to Jira:', error);
          return 'Error generating Jira export';
        }
      }

      function exportToAzure() {
        try {
          let csv = 'Work Item Type,Title,Description,Story Points,Acceptance Criteria\n';
          
          appState.stories.forEach(story => {
            const title = escapeCsv(story.userStory || '');
            const description = escapeCsv(`Epic: ${story.epic || 'General'}\n\n${story.userStory || ''}`);
            const criteria = escapeCsv((story.acceptanceCriteria || []).join('; '));
            
            csv += `"User Story","${title}","${description}","${story.points || ''}","${criteria}"\n`;
          });
          
          return csv;
        } catch (error) {
          console.error('Error exporting to Azure:', error);
          return 'Error generating Azure export';
        }
      }

      function exportToMarkdown() {
        try {
          const projectNameField = safeGetElement('project-name');
          const projectName = projectNameField ? projectNameField.value : 'Project';
          
          let md = `# User Stories - ${escapeHtml(projectName)}\n\n`;
          md += `**Generated:** ${new Date().toLocaleDateString()}\n`;
          md += `**Template:** ${getTemplateDisplayName()}\n`;
          md += `**Total Stories:** ${appState.stories.length}\n`;
          md += `**Total Points:** ${appState.totalPoints}\n\n`;
          
          appState.stories.forEach(story => {
            md += `## ${escapeHtml(story.id || 'Unknown')}`;
            if (story.selectedFields && story.selectedFields.epic && story.epic) {
              md += ` - ${escapeHtml(story.epic)}`;
            }
            md += `\n\n`;
            
            md += `**User Story:** ${escapeHtml(story.userStory || 'No story available')}\n\n`;
            
            if (story.selectedFields && story.selectedFields.points && story.points) {
              md += `**Story Points:** ${escapeHtml(String(story.points))}\n\n`;
            }
            
            if (story.selectedFields && story.selectedFields.criteria && story.acceptanceCriteria && Array.isArray(story.acceptanceCriteria)) {
              md += `**Acceptance Criteria:**\n`;
              story.acceptanceCriteria.forEach(criterion => {
                md += `- ${escapeHtml(criterion)}\n`;
              });
              md += '\n';
            }
            
            md += '---\n\n';
          });
          
          return md;
        } catch (error) {
          console.error('Error exporting to Markdown:', error);
          return 'Error generating Markdown export';
        }
      }

      // UTILITY HELPER FUNCTIONS
      function downloadFile(filename, content) {
        try {
          const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Error downloading file:', error);
          safeShowToast('Error downloading file', 'error');
        }
      }

      function setLoadingState(isLoading, buttonId) {
        try {
          const button = safeGetElement(buttonId || 'generateBtn');
          if (!button) return;
          
          appState.isGenerating = isLoading;
          
          if (isLoading) {
            button.classList.add('loading');
            button.disabled = true;
            const span = button.querySelector('span');
            if (span) span.style.opacity = '0';
          } else {
            button.classList.remove('loading');
            button.disabled = false;
            const span = button.querySelector('span');
            if (span) span.style.opacity = '1';
          }
        } catch (error) {
          console.error('Error setting loading state:', error);
        }
      }

      function showFieldError(fieldId, message) {
        try {
          const field = safeGetElement(fieldId);
          if (!field) return;
          
          field.classList.add('error');
          
          const existingError = field.parentNode.querySelector('.error-message');
          if (existingError) existingError.remove();
          
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.textContent = message;
          field.parentNode.appendChild(errorDiv);
          
          field.focus();
        } catch (error) {
          console.error('Error showing field error:', error);
        }
      }

      function clearErrors() {
        try {
          safeQuerySelectorAll('.error').forEach(el => el.classList.remove('error'));
          safeQuerySelectorAll('.error-message').forEach(el => el.remove());
        } catch (error) {
          console.error('Error clearing errors:', error);
        }
      }

      function escapeHtml(text) {
        try {
          if (typeof text !== 'string') return '';
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        } catch (error) {
          return String(text || '');
        }
      }

      function escapeCsv(text) {
        try {
          if (typeof text !== 'string') return '';
          return text.replace(/"/g, '""');
        } catch (error) {
          return String(text || '');
        }
      }

      // SETUP DRAG AND DROP
      function setupDragAndDrop() {
        try {
          const uploadArea = safeGetElement('upload-area');
          if (!uploadArea) return;
          
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
          });
          
          function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
          }
          
          ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
          });
          
          ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
          });
          
          function highlight() {
            uploadArea.classList.add('dragover');
          }
          
          function unhighlight() {
            uploadArea.classList.remove('dragover');
          }
          
          uploadArea.addEventListener('drop', handleDrop, false);
          
          function handleDrop(e) {
            try {
              const dt = e.dataTransfer;
              const files = dt.files;
              
              if (files.length > 0) {
                const file = files[0];
                const event = { target: { files: [file] } };
                handleFileUpload(event);
              }
            } catch (error) {
              console.error('Error handling drop:', error);
            }
          }
        } catch (error) {
          console.error('Error setting up drag and drop:', error);
        }
      }

      // EVENT LISTENERS SETUP
      function setupEventListeners() {
        try {
          // Choice buttons
          safeQuerySelectorAll('.choice-button').forEach(button => {
            button.addEventListener('click', function() {
              const choice = this.dataset.choice;
              if (choice) selectChoice(choice);
            });
            
            button.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const choice = this.dataset.choice;
                if (choice) selectChoice(choice);
              }
            });
          });
          
          // Template cards
          safeQuerySelectorAll('.template-card').forEach(card => {
            card.addEventListener('click', function() {
              const template = this.dataset.template;
              if (template) selectTemplate(template);
            });
            
            card.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const template = this.dataset.template;
                if (template) selectTemplate(template);
              }
            });
          });
          
          // Sample input
          const sampleInput = safeGetElement('sample-story-input');
          if (sampleInput) {
            sampleInput.addEventListener('input', function() {
              analyzePattern(this.value);
            });
          }
          
          // File upload
          const fileInput = safeGetElement('file-input');
          if (fileInput) {
            fileInput.addEventListener('change', handleFileUpload);
          }
          
          const uploadArea = safeGetElement('upload-area');
          if (uploadArea) {
            uploadArea.addEventListener('click', function() {
              const fileInput = safeGetElement('file-input');
              if (fileInput) fileInput.click();
            });
            
            uploadArea.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const fileInput = safeGetElement('file-input');
                if (fileInput) fileInput.click();
              }
            });
          }
          
          // Action buttons
          const generateBtn = safeGetElement('generateBtn');
          if (generateBtn) {
            generateBtn.addEventListener('click', generateStories);
          }
          
          const refineBtn = safeGetElement('refineBtn');
          if (refineBtn) {
            refineBtn.addEventListener('click', refineStories);
          }
          
          const clearBtn = safeGetElement('clearBtn');
          if (clearBtn) {
            clearBtn.addEventListener('click', clearAll);
          }
          
          // Export buttons
          safeQuerySelectorAll('.export-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const format = this.dataset.format;
              if (format) exportFormat(format);
            });
            
            btn.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const format = this.dataset.format;
                if (format) exportFormat(format);
              }
            });
          });
          
          // Output field items
          safeQuerySelectorAll('.output-field-item').forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox && !checkbox.disabled) {
              item.addEventListener('click', function(e) {
                if (e.target.type !== 'checkbox') {
                  checkbox.checked = !checkbox.checked;
                }
              });
            }
          });
          
          // Keyboard shortcuts
          document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && !appState.isGenerating) {
              e.preventDefault();
              generateStories();
            }
          });
          
        } catch (error) {
          console.error('Error setting up event listeners:', error);
        }
      }

      // INITIALIZATION FUNCTION
      function initializeApp() {
        try {
          console.log('=== USB - User Story Builder Initializing (PRODUCTION VERSION) ===');
          
          const projectNameField = safeGetElement('project-name');
          if (projectNameField) {
            projectNameField.focus();
          }
          
          setupDragAndDrop();
          setupEventListeners();
          
          appState.selectedTemplate = 'classic';
          appState.templateMode = 'learn';
          updateTemplateSelection();
          
          console.log('=== Production Initialization Complete ===');
          
          setTimeout(() => {
            safeShowToast('USB - User Story Builder ready! Production version loaded successfully.', 'success');
          }, 1000);
          
        } catch (error) {
          console.error('Error initializing app:', error);
          safeShowToast('Error initializing application. Please refresh the page.', 'error');
        }
      }

      // INITIALIZE APP WHEN DOM IS READY
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }

    })(); // End of IIFE
  </script>
</body>
</html>